# A6: Integrity constraints. Indexes, triggers, user functions and database populated with data

## 1. Database workload

### 1.1. Estimate of tuples

| Relation Reference | Relation Name        | Order of Magnitude | Estimated Growth   |
| ------------------ | -------------------- | ------------------ | ------------------ |
| R01                | user                 | thousands          | tens per day       |
| R02                | band                 | hundreds           | units per day      |
| R03                | content              | thousands          | tens per day       |
| R04                | post                 | thousands          | tens per day       |
| R05                | message              | thousands          | hundreds per day   |
| R06                | comment              | thousands          | tens per day       |
| R07                | country              | tens               | no growth expected |
| R08                | city                 | hundreds           | no growth expected |
| R09                | genre                | tens               | no growth expected |
| R10                | skill                | tens               | no growth expected |
| R11                | report               | hundreds           | units per week     |
| R12                | ban                  | tens               | units per month    |
| R13                | notification_trigger | thousands          | tens per day       |
| R14                | user_skill           | thousands          | tens per day       |
| R15                | user_follower        | thousands          | tens per day       |
| R16                | user_rating          | thousands          | tens per day       |
| R17                | user_genre           | thousands          | tens per day       |
| R18                | user_warning         | tens               | units per month    |
| R19                | band_genre           | hundreds           | units per day      |
| R20                | band_membership      | thousands          | units per day      |
| R21                | band_rating          | thousands          | tens per day       |
| R22                | band_warning         | tens               | units per month    |
| R23                | band_follower        | thousands          | tens per day       |
| R24                | band_application     | hundreds           | units per day      |
| R25                | band_invitation      | hundreds           | units per day      |
| R26                | user_notification    | thousands          | tens per day       |

### 1.2. Most frequent queries

| Query Reference | Query description  | Query Frequency  | SQL Code                                                                                                                                                                                                                                                                                                                                         |
| --------------- | ------------------ | ---------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| SELECT01        | User Profile       | hundreds per day | <code> select * from mb_user where mb_user.username = $username; </code>                                                                                                                                                                                                                                                                         |
| SELECT02        | Band Profile       | hundreds per day | <code> select * from band where band.name = $bandname; </code>                                                                                                                                                                                                                                                                                   |
| SELECT03        | User Notifications | tens per day     | <code> select * from user_notification where user_notification.userId = $userId; </code>                                                                                                                                                                                                                                                         |
| SELECT04        | User Posts         | tens per day     | <code> select * from post where post.posterId = $userId or post.bandId = $bandId; </code>                                                                                                                                                                                                                                                        |
| SELECT05        | Register           | tens per day     | <code> select a.username from mb_user a where exists (select b.username from mb_user b where a.username = b.username and a<b); </code>                                                                                                                                                                                                           |
| SELECT06        | Search             | tens per day     | <code> select * from band join band_membership on band.id = band_membership.bandId and band.id like %$search_text% join mb_user on mb_user.id = band_membership.userId and band.id like %$search_text% or mb_user.id like %$search_text%; </code>                                                                                                |
| SELECT07        | Feed Posts         | hundreds per day | <code> select * from post join user_follower on (post.posterId = user_follower.followedUserId join mb_user on user_follower.followingUserId = mb_user.id and mb_user.username = $username) join band_follower on (post.bandId = band_follower.bandId join mb_user on band_follower.userId = mb_user.id and mb_user.username = $username);</code> |
| SELECT08        | Followers          | tens per day     | <code> select * from user_follower join mb_user as users1 on users1.id = user_follower.followingUserId join mb_user as users2 on user_follower.followedUserId = users2.id and users2.username = $username;</code>                                                                                                                                |
| SELECT09        | Following User     | tens per day     | <code> select * from user_follower join mb_user as users1 on users1.id = user_follower.followedUserId join mb_user as users2 on user_follower.followingUserId = users2.id and users2.username = $username;</code>                                                                                                                                |
| SELECT10        | Following Band     | tens per day     | <code> select * from band_follower join band on band_follower.bandId = band.id and band.name = $bandname join mb_user on band_follower.userId = mb_user.id;</code>                                                                                                                                                                               |
| SELECT11        | User's Bands       | tens per day     | <code> select * from band join band_membership on band.id = band_membership.bandId join mb_user on mb_user.username = $username and mb_user.id = band_membership.userId;</code>                                                                                                                                                                  |
| SELECT12        | Reported Content   | units per day    | <code> select * from content join report on report.reportedContentId = content.id;</code>                                                                                                                                                                                                                                                        |
| SELECT13        | Users' Info        | units per day    | <code> select * from mb_user;</code>                                                                                                                                                                                                                                                                                                             |
| SELECT14        | Bands' Info        | units per day    | <code> select * from band;</code>                                                                                                                                                                                                                                                                                                                |
| SELECT15        | Band's Posts       | tens per day     | <code> select * from post join band on post.bandId = band.id and band.name = $bandname;</code>                                                                                                                                                                                                                                                   |


### 1.3. Most frequent modifications

| Query Reference | Query Description | Query Frequency | SQL Code                                                                                                                                                                                                                        |
| --------------- | ----------------- | --------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| INSERT01        | Register User     | tens per day    | <code>INSERT INTO user(username, password, name) VALUES($username, $password, $name);</code>                                                                                                                                    |
| INSERT02        | Create Band       | tens per week   | <code>INSERT INTO band(name, creationDate) VALUES($name, $creationDate);</code>                                                                                                                                                 |
| INSERT03        | Report            | units per week  | <code>INSERT INTO report(text, date, reportTypeID) VALUES($text, $date, $reportTypeID);</code>                                                                                                                                  |
| INSERT04        | Ban               | units per month | <code>INSERT INTO ban(reason, banDate, ceaseDate, adminID, bannedID) VALUES($reason, $banDate, $ceaseDate, $adminID, $bannedID);</code>                                                                                         |
| INSERT05        | Create Post       | tens per day    | <code>INSERT INTO post(contentId,posterId,bandId) VALUES($contentId,$posterId,$bandId);</code>                                                                                                                                  |
| DELETE01        | Delete Post       | units per month | <code>DELETE FROM post WHERE post.id = $id;</code>                                                                                                                                                                              |
| DELETE02        | Unfollow User     | units per day   | <code>DELETE FROM user_follower JOIN mb_user ON user_follower.followingUserId = mb_user.id and mb_user.username = $following JOIN mb_user ON user_follower.followedUserId = mb_user.id and mb_user.username = $followed;</code> |
| DELETE03        | Unfollow Band     | units per day   | <code>DELETE FROM band_follower JOIN band ON band_follower.bandId = band.id and band.name = $bandname JOIN mb_user ON mb_user.id = band_follower.userId and mb_user.username = $username;</code>                                |
| UPDATE01        | Change Password   | units per month | <code>UPDATE mb_user SET mb_user.password = $new_password WHERE mb_user.username = $username;</code>                                                                                                                            |
| UPDATE02        | Change Bio        | units per month | <code>UPDATE mb_user SET mb_user.bio = $new_bio WHERE mb_user.username = $username;</code>                                                                                                                                      |


## 2. Proposed indexes
### 2.1. Performance Indexes
  
| Index Reference | Related Queries | Index Relation | Index Attribute | Index Type | Cardinality | Clustering | SQL Code                                                          |
| --------------- | --------------- | -------------- | --------------- | ---------- | ----------- | ---------- | ----------------------------------------------------------------- |
| IDX01           | SELECT04        | post           | posterId        | hash       | medium      | yes        | <code>CREATE INDEX user_post ON post USING hash(posterId);</code> |

**IDX01 justification**: Query SELECT04 searches for a user's posts, having to be fast, since it is used several times; doesn't need range query support; cardinality is medium, so it is a good candidate for clustering.
 
### 2.2. Full-text Search Indexes

| Index Reference | Related Queries | Index Relation | Index Attribute | Index Type | Clustering | SQL Code                                                                                        |
| --------------- | --------------- | -------------- | --------------- | ---------- | ---------- | ----------------------------------------------------------------------------------------------- |
| IDX02           | SELECT06        | band           | name            | GIST       | no         | <code>CREATE INDEX search_band ON band USING GIST (to_tsvector('english', name));</code>        |
| IDX03           | SELECT06        | mb_user        | username        | GIST       | no         | <code>CREATE INDEX search_user ON mb_user USING GIST (to_tsvector('english', username));</code> |

**IDX02 justification**: Optimize the search of a band's name with dynamic data.

**IDX03 justification**: Optimize the search of a user's username with dynamic data.


## 3. Triggers and Integrity Constraints

| Integrity Constraint Reference | Integrity Description                                                                                                                                                                                | SQL Code                                                                                        |
| ------------------------------ | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------- |
| IC1                            | Post on behalf of the band or individual post. Post has one field, bandId which denotes if it is a post on behalf of a band. If so, the posterId field must refer to a user who belongs to that band | # A6: Integrity constraints. Indexes, triggers, user functions and database populated with data |

## 1. Database workload

### 1.1. Estimate of tuples

| Relation Reference | Relation Name        | Order of Magnitude | Estimated Growth   |
| ------------------ | -------------------- | ------------------ | ------------------ |
| R01                | user                 | thousands          | tens per day       |
| R02                | band                 | hundreds           | units per day      |
| R03                | content              | thousands          | tens per day       |
| R04                | post                 | thousands          | tens per day       |
| R05                | message              | thousands          | hundreds per day   |
| R06                | comment              | thousands          | tens per day       |
| R07                | country              | tens               | no growth expected |
| R08                | city                 | hundreds           | no growth expected |
| R09                | genre                | tens               | no growth expected |
| R10                | skill                | tens               | no growth expected |
| R11                | report               | hundreds           | units per week     |
| R12                | ban                  | tens               | units per month    |
| R13                | notification_trigger | thousands          | tens per day       |
| R14                | user_skill           | thousands          | tens per day       |
| R15                | user_follower        | thousands          | tens per day       |
| R16                | user_rating          | thousands          | tens per day       |
| R17                | user_genre           | thousands          | tens per day       |
| R18                | user_warning         | tens               | units per month    |
| R19                | band_genre           | hundreds           | units per day      |
| R20                | band_membership      | thousands          | units per day      |
| R21                | band_rating          | thousands          | tens per day       |
| R22                | band_warning         | tens               | units per month    |
| R23                | band_follower        | thousands          | tens per day       |
| R24                | band_application     | hundreds           | units per day      |
| R25                | band_invitation      | hundreds           | units per day      |
| R26                | user_notification    | thousands          | tens per day       |

### 1.2. Most frequent queries

| Query Reference | Query description  | Query Frequency  | SQL Code                                                                                                                                                                                                                                                                                                                                         |
| --------------- | ------------------ | ---------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| SELECT01        | User Profile       | hundreds per day | <code> select * from mb_user where mb_user.username = $username; </code>                                                                                                                                                                                                                                                                         |
| SELECT02        | Band Profile       | hundreds per day | <code> select * from band where band.name = $bandname; </code>                                                                                                                                                                                                                                                                                   |
| SELECT03        | User Notifications | tens per day     | <code> select * from user_notification where user_notification.userId = $userId; </code>                                                                                                                                                                                                                                                         |
| SELECT04        | User Posts         | tens per day     | <code> select * from post where post.posterId = $userId or post.bandId = $bandId; </code>                                                                                                                                                                                                                                                        |
| SELECT05        | Register           | tens per day     | <code> select a.username from mb_user a where exists (select b.username from mb_user b where a.username = b.username and a<b); </code>                                                                                                                                                                                                           |
| SELECT06        | Search             | tens per day     | <code> select * from band join band_membership on band.id = band_membership.bandId and band.id like %$search_text% join mb_user on mb_user.id = band_membership.userId and band.id like %$search_text% or mb_user.id like %$search_text%; </code>                                                                                                |
| SELECT07        | Feed Posts         | hundreds per day | <code> select * from post join user_follower on (post.posterId = user_follower.followedUserId join mb_user on user_follower.followingUserId = mb_user.id and mb_user.username = $username) join band_follower on (post.bandId = band_follower.bandId join mb_user on band_follower.userId = mb_user.id and mb_user.username = $username);</code> |
| SELECT08        | Followers          | tens per day     | <code> select * from user_follower join mb_user as users1 on users1.id = user_follower.followingUserId join mb_user as users2 on user_follower.followedUserId = users2.id and users2.username = $username;</code>                                                                                                                                |
| SELECT09        | Following User     | tens per day     | <code> select * from user_follower join mb_user as users1 on users1.id = user_follower.followedUserId join mb_user as users2 on user_follower.followingUserId = users2.id and users2.username = $username;</code>                                                                                                                                |
| SELECT10        | Following Band     | tens per day     | <code> select * from band_follower join band on band_follower.bandId = band.id and band.name = $bandname join mb_user on band_follower.userId = mb_user.id;</code>                                                                                                                                                                               |
| SELECT11        | User's Bands       | tens per day     | <code> select * from band join band_membership on band.id = band_membership.bandId join mb_user on mb_user.username = $username and mb_user.id = band_membership.userId;</code>                                                                                                                                                                  |
| SELECT12        | Reported Content   | units per day    | <code> select * from content join report on report.reportedContentId = content.id;</code>                                                                                                                                                                                                                                                        |
| SELECT13        | Users' Info        | units per day    | <code> select * from mb_user;</code>                                                                                                                                                                                                                                                                                                             |
| SELECT14        | Bands' Info        | units per day    | <code> select * from band;</code>                                                                                                                                                                                                                                                                                                                |
| SELECT15        | Band's Posts       | tens per day     | <code> select * from post join band on post.bandId = band.id and band.name = $bandname;</code>                                                                                                                                                                                                                                                   |


### 1.3. Most frequent modifications

| Query Reference | Query Description | Query Frequency | SQL Code                                                                                                                                                                                                                        |
| --------------- | ----------------- | --------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| INSERT01        | Register User     | tens per day    | <code>INSERT INTO user(username, password, name) VALUES($username, $password, $name);</code>                                                                                                                                    |
| INSERT02        | Create Band       | tens per week   | <code>INSERT INTO band(name, creationDate) VALUES($name, $creationDate);</code>                                                                                                                                                 |
| INSERT03        | Report            | units per week  | <code>INSERT INTO report(text, date, reportTypeID) VALUES($text, $date, $reportTypeID);</code>                                                                                                                                  |
| INSERT04        | Ban               | units per month | <code>INSERT INTO ban(reason, banDate, ceaseDate, adminID, bannedID) VALUES($reason, $banDate, $ceaseDate, $adminID, $bannedID);</code>                                                                                         |
| INSERT05        | Create Post       | tens per day    | <code>INSERT INTO post(contentId,posterId,bandId) VALUES($contentId,$posterId,$bandId);</code>                                                                                                                                  |
| DELETE01        | Delete Post       | units per month | <code>DELETE FROM post WHERE post.id = $id;</code>                                                                                                                                                                              |
| DELETE02        | Unfollow User     | units per day   | <code>DELETE FROM user_follower JOIN mb_user ON user_follower.followingUserId = mb_user.id and mb_user.username = $following JOIN mb_user ON user_follower.followedUserId = mb_user.id and mb_user.username = $followed;</code> |
| DELETE03        | Unfollow Band     | units per day   | <code>DELETE FROM band_follower JOIN band ON band_follower.bandId = band.id and band.name = $bandname JOIN mb_user ON mb_user.id = band_follower.userId and mb_user.username = $username;</code>                                |
| UPDATE01        | Change Password   | units per month | <code>UPDATE mb_user SET mb_user.password = $new_password WHERE mb_user.username = $username;</code>                                                                                                                            |
| UPDATE02        | Change Bio        | units per month | <code>UPDATE mb_user SET mb_user.bio = $new_bio WHERE mb_user.username = $username;</code>                                                                                                                                      |


## 2. Proposed indexes
### 2.1. Performance Indexes
  
| Index Reference | Related Queries | Index Relation | Index Attribute | Index Type | Cardinality | Clustering | SQL Code                                                          |
| --------------- | --------------- | -------------- | --------------- | ---------- | ----------- | ---------- | ----------------------------------------------------------------- |
| IDX01           | SELECT04        | post           | posterId        | hash       | medium      | yes        | <code>CREATE INDEX user_post ON post USING hash(posterId);</code> |

**IDX01 justification**: Query SELECT04 searches for a user's posts, having to be fast, since it is used several times; doesn't need range query support; cardinality is medium, so it is a good candidate for clustering.
 
### 2.2. Full-text Search Indexes

| Index Reference | Related Queries | Index Relation | Index Attribute | Index Type | Clustering | SQL Code                                                                                        |
| --------------- | --------------- | -------------- | --------------- | ---------- | ---------- | ----------------------------------------------------------------------------------------------- |
| IDX02           | SELECT06        | band           | name            | GIST       | no         | <code>CREATE INDEX search_band ON band USING GIST (to_tsvector('english', name));</code>        |
| IDX03           | SELECT06        | mb_user        | username        | GIST       | no         | <code>CREATE INDEX search_user ON mb_user USING GIST (to_tsvector('english', username));</code> |

**IDX02 justification**: Optimize the search of a band's name with dynamic data.

**IDX03 justification**: Optimize the search of a user's username with dynamic data.


## 3. Triggers and Integrity Constraints

| Integrity Constraint Reference | Integrity Description                                                                                                                                                                                | SQL Code   |
| ------------------------------ | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ---------- |
| IC1                            | Post on behalf of the band or individual post. Post has one field, bandId which denotes if it is a post on behalf of a band. If so, the posterId field must refer to a user who belongs to that band | view below |

```sql 

CREATE FUNCTION check_band_post() RETURNS trigger AS $check_band_post$BEGIN
       
        IF NEW.bandId IS NOT NULL THEN

            IF check_user_belongs_to_band(New.posterId, New.bandId) = FALSE THEN

                RAISE EXCEPTION 'this user does not belong to the band, post not inserted';

            END IF;

        END IF;

    
        RETURN NEW;

    END;
    
$check_band_post$ LANGUAGE plpgsql;

CREATE TRIGGER check_band_post BEFORE INSERT OR UPDATE ON post
    FOR EACH ROW EXECUTE PROCEDURE check_band_post(); 

```
| Integrity Constraint Reference | Integrity Description                                                                                                                                                                                | SQL Code   |
| ------------------------------ | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ---------- |
| IC2                            | A ban is either a band ban or user band. To to that, both fields are mutually exclusive  |view below|


```sql

CREATE FUNCTION check_xor_user_band() RETURNS trigger AS $check_xor_user_band$
    BEGIN
        --Check if both user and ban are empty--
        IF NEW.userId IS NULL AND NEW.bandId IS NULL THEN
            RAISE EXCEPTION 'userId and bandId cannot be both null';
        END IF;

        --Check if both are not null
        IF NEW.userId IS NOT NULL AND NEW.bandId IS NOT NULL THEN
            RAISE EXCEPTION 'userId and bandId cannot be both not null (%,%)', NEW.userId, New.bandId;
        END IF;

        RETURN NEW;

    END;

$check_xor_user_band$ LANGUAGE plpgsql;

CREATE TRIGGER check_xor_user_band BEFORE INSERT OR UPDATE ON ban
    FOR EACH ROW EXECUTE PROCEDURE check_xor_user_band();


```

| Integrity Constraint Reference | Integrity Description                                                                                                                                                                                | SQL Code   |
| ------------------------------ | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ---------- |
| IC3                            | A notification has a type so it is easy to check which is the origin  |view below|

```sql

CREATE TYPE NOTIFICATION_TYPE AS ENUM (
    'user_follower', 'band_follower', 'message', 'comment', 'band_application',
    'band_invitation', 'user_warning', 'band_warning', 'band_invitation_accepted',
    'band_invitation_rejected', 'band_application_accepted', 'band_application_rejected');

CREATE TABLE notification_trigger (

    id SERIAL NOT NULL,
    date TIMESTAMP NOT NULL DEFAULT now(),
    type NOTIFICATION_TYPE NOT NULL,
    originUserFollower INTEGER,
    originBandFollower INTEGER,
    originMessage INTEGER,
    originComment INTEGER,
    originBandApplication INTEGER,
    originBandInvitation INTEGER,
    originUserWarning INTEGER,
    originBandWarning INTEGER
);

```

| Integrity Constraint Reference | Integrity Description                                                                                                                                                                                | SQL Code   |
| ------------------------------ | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ---------- |
| IC4                            | A notification has a type so it has only and only one origin  |view below|

```sql


CREATE FUNCTION check_xor_notification_origin() RETURNS trigger AS $check_xor_notification_origin$
    BEGIN

        --Check for correct type and origin
        IF NEW.type = 'user_follower' AND NEW.originUserFollower IS NULL THEN
            RAISE EXCEPTION 'type user follower without originUserFollowerId';
        END IF;

        IF NEW.type = 'band_follower' AND NEW.originBandFollower IS NULL THEN
            RAISE EXCEPTION 'type band follower without bandFollowerId';
        END IF;

        IF NEW.type = 'message' AND NEW.originMessage IS NULL THEN
            RAISE EXCEPTION 'type message without originMessageId';
        END IF;

        IF NEW.type = 'comment' AND NEW.originComment IS NULL THEN
            RAISE EXCEPTION 'type comment without originCommentId';
        END IF;

        IF NEW.type = 'band_application' AND NEW.originBandApplication IS NULL THEN
            RAISE EXCEPTION 'type band application without originBandApplicationId';
        END IF;

        IF NEW.type = 'band_invitation' AND NEW.originBandInvitation IS NULL THEN
            RAISE EXCEPTION 'type band invitation without band invitation Id';
        END IF;

        IF NEW.type = 'user_warning' AND NEW.originUserWarning IS NULL THEN
            RAISE EXCEPTION 'type user warning without origin user warning id';
        END IF;

        IF NEW.TYPE = 'band_warning' AND NEW.originBandWarning IS NULL THEN
            RAISE EXCEPTION 'type band warning without band warning Id';
        END IF;

        IF NEW.TYPE = 'band_invitation_accepted' AND NEW.originBandInvitation IS NULL THEN
            RAISE EXCEPTION 'type band invitation accepted without band inivitation Id';
        END IF;

         IF NEW.TYPE = 'band_invitation_rejected' AND NEW.originBandInvitation IS NULL THEN
            RAISE EXCEPTION 'type band invitation rejected without band inivitation Id';
        END IF;

        IF NEW.TYPE = 'band_application_accepted' AND NEW.originBandApplication IS NULL THEN
            RAISE EXCEPTION 'type band application accepted without band application Id';
        END IF;

        IF NEW.TYPE = 'band_application_rejected' AND NEW.originBandApplication IS NULL THEN
            RAISE EXCEPTION 'type band application accepted without band application Id';
        END IF;

        RETURN NEW;

    END;
$check_xor_notification_origin$ LANGUAGE plpgsql;

CREATE TRIGGER check_xor_notification_origin BEFORE INSERT OR UPDATE ON notification_trigger
    FOR EACH ROW EXECUTE PROCEDURE check_xor_notification_origin();

```
| Integrity Constraint Reference | Integrity Description                                                                                                                                                                                | SQL Code   |
| ------------------------------ | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ---------- |
| IC5                            | In a band chat, the sender id has to be a member of the band, so if the destination of a message is a band, the field id must refer to a user which belongs to the band| view below |

```sql

CREATE FUNCTION check_user_belongs_to_band(userIdToCheck Integer, bandIdToCheck Integer) RETURNS BOOLEAN AS $$
    
    DECLARE result BOOLEAN;

    BEGIN
       
        SELECT EXISTS (SELECT band.id FROM band JOIN band_membership ON band.id = band_membership.bandId WHERE band.id = bandIdToCheck AND band_membership.userId = userIdToCheck) INTO result;
        
        RETURN result;

    END;

$$ LANGUAGE plpgsql;


CREATE FUNCTION check_band_message() RETURNS trigger AS $check_band_message$
    BEGIN
       
        IF NEW.bandId IS NOT NULL THEN

            IF check_user_belongs_to_band(New.senderId, New.bandId) = FALSE THEN

                RAISE EXCEPTION 'this user does not belong to the band';

            END IF;

        END IF;

    
        RETURN NEW;

    END;

$check_band_message$ LANGUAGE plpgsql;

CREATE TRIGGER check_band_message BEFORE INSERT OR UPDATE ON message
    FOR EACH ROW EXECUTE PROCEDURE check_band_message();

```

| Integrity Constraint Reference | Integrity Description                                                                                                                                                                                | SQL Code   |
| ------------------------------ | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ---------- |
| IC6                            | A message destination is either a band or a user, they are mutually exclusive| view below |

```sql

CREATE FUNCTION check_xor_message_destination() RETURNS trigger AS $check_xor_message_destination$
    BEGIN
        
        IF NEW.receiverId IS NULL AND NEW.bandId IS NULL THEN
            RAISE EXCEPTION 'receiverId and bandId cannot be both null';
        END IF;

        IF NEW.receiverId IS NOT NULL AND NEW.bandId IS NOT NULL THEN
            RAISE EXCEPTION 'receiverId and bandId cannot be both not null (%,%)', NEW.receiverId, New.bandId;
        END IF;

        RETURN NEW;

    END;
$check_xor_message_destination$ LANGUAGE plpgsql;

CREATE TRIGGER check_xor_message_destination BEFORE INSERT OR UPDATE ON message
    FOR EACH ROW EXECUTE PROCEDURE check_xor_message_destination();


```

| Integrity Constraint Reference | Integrity Description                                                                                                                                                                                | SQL Code   |
| ------------------------------ | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ---------- |
| IC7                            | A report has a type so it is clearly identified who or what is being reported| view below |

```sql

CREATE TYPE REPORT_TYPE AS ENUM ('user_report', 'band_report', 'content_report');

CREATE TABLE report (

    id SERIAL NOT NULL,
    text TEXT NOT NULL,
    date TIMESTAMP DEFAULT now(),
    reportType REPORT_TYPE NOT NULL,
    reportedContentId INTEGER,
    reportedUserId INTEGER,
    reportedBandId INTEGER,
    reporterUserId INTEGER
);


```

| Integrity Constraint Reference | Integrity Description                                                                                                                                                                                | SQL Code   |
| ------------------------------ | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ---------- |
| IC8                           | A report has a type so the origin of the report is only one | view below |

```sql

CREATE FUNCTION check_xor_report_type() RETURNS trigger AS $check_xor_report_type$
    BEGIN
        --Check for correct type
        IF NEW.reportType = 'user_report' AND NEW.reportedUserId IS NULL THEN
            RAISE EXCEPTION 'type user_report without reportedUserId';
        END IF;

        IF NEW.reportType = 'band_report' AND NEW.reportedBandId IS NULL THEN
            RAISE EXCEPTION 'type user_report without reportedBandId';
        END IF;

        IF NEW.reportType = 'content_report' AND NEW.reporterUserId IS NULL THEN
            RAISE EXCEPTION 'type user_report without reporterUserId';
        END IF;

        RETURN NEW;

    END;
$check_xor_report_type$ LANGUAGE plpgsql;

CREATE TRIGGER check_xor_report_type BEFORE INSERT OR UPDATE ON report
    FOR EACH ROW EXECUTE PROCEDURE check_xor_report_type();


```

| Integrity Constraint Reference | Integrity Description                                                                                                                                                                                | SQL Code   |
| ------------------------------ | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ---------- |
| IC9                           | A band invitation has 4 identified types of status | view below |

```sql

CREATE TYPE BAND_INVITATION_STATUS AS ENUM ('canceled', 'pending', 'accepted', 'rejected');

CREATE TABLE band_invitation(

    id SERIAL NOT NULL,
    userId INTEGER NOT NULL,
    bandId INTEGER NOT NULL,
    date TIMESTAMP DEFAULT now(),
    lastStatusDate DATE,
    status BAND_INVITATION_STATUS DEFAULT 'pending'

);

```

| Integrity Constraint Reference | Integrity Description                                                                                                                                                                                | SQL Code   |
| ------------------------------ | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ---------- |
| IC10                           | A band application has 4 identified types of status | view below |

```sql

CREATE TYPE BAND_APPLICATION_STATUS AS ENUM ('canceled', 'pending', 'accepted', 'rejected');

CREATE TABLE band_application (

    id SERIAL NOT NULL,
    userId INTEGER NOT NULL,
    bandId INTEGER NOT NULL,
    date TIMESTAMP DEFAULT now(),
    lastStatusDate DATE,
    status BAND_APPLICATION_STATUS DEFAULT 'pending'

);

```

| Integrity Constraint Reference | Integrity Description                                                                                                                                                                                | SQL Code   |
| ------------------------------ | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ---------- |
| IC11                           | Only an admin can insert or update a skill | view below |

```sql

CREATE FUNCTION is_admin (userId INTEGER)
RETURNS BOOLEAN AS $$
DECLARE
    isAdmin BOOLEAN;
BEGIN
   SELECT mb_user.admin INTO isAdmin FROM mb_user WHERE mb_user.id = userId;

   RETURN isAdmin;
END;
$$ LANGUAGE plpgsql;

CREATE FUNCTION check_is_admin_skill() RETURNS trigger AS $check_is_admin_skill$
    BEGIN
        --Check if user is an admin--
        IF NOT is_admin(NEW.creatingAdminId) THEN
            RAISE EXCEPTION 'User is not an Admin';
        END IF;

        RETURN NEW;

    END;
$check_is_admin_skill$ LANGUAGE plpgsql;

CREATE TRIGGER check_is_admin_skill BEFORE INSERT OR UPDATE ON skill
    FOR EACH ROW EXECUTE PROCEDURE check_is_admin_skill();

```

| Integrity Constraint Reference | Integrity Description                                                                                                                                                                                | SQL Code   |
| ------------------------------ | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ---------- |
| IC12                           | Only an admin can insert or update a genre | view below |

```sql

CREATE FUNCTION is_admin (userId INTEGER)
RETURNS BOOLEAN AS $$
DECLARE
    isAdmin BOOLEAN;
BEGIN
   SELECT mb_user.admin INTO isAdmin FROM mb_user WHERE mb_user.id = userId;

   RETURN isAdmin;
END;
$$ LANGUAGE plpgsql;

CREATE FUNCTION check_is_admin_genre() RETURNS trigger AS $check_is_admin_genre$
    BEGIN
        --Check if user is an admin--
        IF NOT is_admin(NEW.creatingAdminId) THEN
            RAISE EXCEPTION 'User is not an Admin';
        END IF;

        RETURN NEW;

    END;
$check_is_admin_genre$ LANGUAGE plpgsql;

CREATE TRIGGER check_is_admin_genre BEFORE INSERT OR UPDATE ON genre
    FOR EACH ROW EXECUTE PROCEDURE check_is_admin_genre();


```

| Integrity Constraint Reference | Integrity Description                                                                                                                                                                                | SQL Code   |
| ------------------------------ | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ---------- |
| IC13                           | Only an admin can insert or update a ban | view below |

```sql

CREATE FUNCTION is_admin (userId INTEGER)
RETURNS BOOLEAN AS $$
DECLARE
    isAdmin BOOLEAN;
BEGIN
   SELECT mb_user.admin INTO isAdmin FROM mb_user WHERE mb_user.id = userId;

   RETURN isAdmin;
END;
$$ LANGUAGE plpgsql;

CREATE FUNCTION check_is_admin_ban() RETURNS trigger AS $check_is_admin_ban$
    BEGIN
        --Check if user is an admin--
        IF NOT is_admin(NEW.adminId) THEN
            RAISE EXCEPTION 'User is not an Admin';
        END IF;

        RETURN NEW;

    END;
$check_is_admin_ban$ LANGUAGE plpgsql;

CREATE TRIGGER check_is_admin_ban BEFORE INSERT OR UPDATE ON ban
    FOR EACH ROW EXECUTE PROCEDURE check_is_admin_ban();


```

| Integrity Constraint Reference | Integrity Description                                                                                                                                                                                | SQL Code   |
| ------------------------------ | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ---------- |
| IC14                           | Only an admin can warn a user | view below |

```sql

CREATE FUNCTION is_admin (userId INTEGER)
RETURNS BOOLEAN AS $$
DECLARE
    isAdmin BOOLEAN;
BEGIN
   SELECT mb_user.admin INTO isAdmin FROM mb_user WHERE mb_user.id = userId;

   RETURN isAdmin;
END;
$$ LANGUAGE plpgsql;

CREATE FUNCTION check_is_admin_user_warning() RETURNS trigger AS $check_is_admin_user_warning$
    BEGIN
        --Check if user is an admin--
        IF NOT is_admin(NEW.adminId) THEN
            RAISE EXCEPTION 'User is not an Admin';
        END IF;

        RETURN NEW;

    END;
$check_is_admin_user_warning$ LANGUAGE plpgsql;

CREATE TRIGGER check_is_admin_user_warning BEFORE INSERT OR UPDATE ON user_warning
    FOR EACH ROW EXECUTE PROCEDURE check_is_admin_user_warning();


```

| Integrity Constraint Reference | Integrity Description                                                                                                                                                                                | SQL Code   |
| ------------------------------ | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ---------- |
| IC15                           | Only an admin can warn a band | view below |

```sql

CREATE FUNCTION is_admin (userId INTEGER)
RETURNS BOOLEAN AS $$
DECLARE
    isAdmin BOOLEAN;
BEGIN
   SELECT mb_user.admin INTO isAdmin FROM mb_user WHERE mb_user.id = userId;

   RETURN isAdmin;
END;
$$ LANGUAGE plpgsql;

CREATE FUNCTION check_is_admin_band_warning() RETURNS trigger AS $check_is_admin_band_warning$
    BEGIN
        --Check if user is an admin--
        IF NOT is_admin(NEW.adminId) THEN
            RAISE EXCEPTION 'User is not an Admin';
        END IF;

        RETURN NEW;

    END;
$check_is_admin_band_warning$ LANGUAGE plpgsql;

CREATE TRIGGER check_is_admin_band_warning BEFORE INSERT OR UPDATE ON band_warning
    FOR EACH ROW EXECUTE PROCEDURE check_is_admin_band_warning();


```

| Trigger Reference | Trigger Description | SQL Code |
| ----------------- | ------------------- | -------- |
| TRIGGER01         | When a user starts following another user the database triggers a new row in the notification_trigger table so the notification trigger can further generate the the needed user_notifications                    | see below    |

```sql

CREATE FUNCTION insert_notification_trigger_user_follower() RETURNS trigger AS $$
    BEGIN
       
        INSERT INTO notification_trigger(type,originUserFollower) VALUES('user_follower',New.id);
        RETURN NEW;

    END;
    
$$ LANGUAGE plpgsql;

CREATE TRIGGER insert_notification_trigger_user_follower AFTER INSERT ON user_follower
    FOR EACH ROW EXECUTE PROCEDURE insert_notification_trigger_user_follower();


```

| Trigger Reference | Trigger Description | SQL Code |
| ----------------- | ------------------- | -------- |
| TRIGGER02         | When a user starts following a band, the database triggers a new row in the notification_trigger table so the notification trigger can further generate the the needed user_notifications                    | see below    |

```sql

CREATE FUNCTION insert_notification_trigger_band_follower() RETURNS trigger AS $$
    BEGIN
       
        INSERT INTO notification_trigger(type,originBandFollower) VALUES('band_follower',New.id);
        RETURN NEW;

    END;
    
$$ LANGUAGE plpgsql;

CREATE TRIGGER insert_notification_trigger_band_follower AFTER INSERT ON band_follower
    FOR EACH ROW EXECUTE PROCEDURE insert_notification_trigger_band_follower();


```

| Trigger Reference | Trigger Description | SQL Code |
| ----------------- | ------------------- | -------- |
| TRIGGER03         | When a user sends a message, the database triggers a new row in the notification_trigger table so the notification trigger can further generate the the needed user_notifications                    | see below    |

```sql

CREATE FUNCTION insert_notification_trigger_message() RETURNS trigger AS $$
    BEGIN
       
        INSERT INTO notification_trigger(type,originMessage) VALUES('message',New.id);
        RETURN NEW;

    END;
    
$$ LANGUAGE plpgsql;

CREATE TRIGGER insert_notification_trigger_message AFTER INSERT ON message
    FOR EACH ROW EXECUTE PROCEDURE insert_notification_trigger_message();

```

| Trigger Reference | Trigger Description | SQL Code |
| ----------------- | ------------------- | -------- |
| TRIGGER04         | When a user comment a post, the database triggers a new row in the notification_trigger table so the notification trigger can further generate the the needed user_notifications                    | see below    |

```sql

CREATE OR REPLACE FUNCTION insert_notification_trigger_comment() RETURNS trigger AS $$
    BEGIN
       
        INSERT INTO notification_trigger(type,originComment) VALUES('comment',New.id);
        RETURN NEW;

    END;
    
$$ LANGUAGE plpgsql;

CREATE TRIGGER insert_notification_trigger_comment AFTER INSERT ON comment
    FOR EACH ROW EXECUTE PROCEDURE insert_notification_trigger_comment();


```

| Trigger Reference | Trigger Description | SQL Code |
| ----------------- | ------------------- | -------- |
| TRIGGER05         | When a user apply to a band, the database triggers a new row in the notification_trigger table so the notification trigger can further generate the the needed user_notifications                    | see below    |


```sql

CREATE OR REPLACE FUNCTION insert_notification_trigger_band_application() RETURNS trigger AS $$
    BEGIN
       
        INSERT INTO notification_trigger(type,originBandApplication) VALUES('band_application',New.id);
        RETURN NEW;

    END;
    
$$ LANGUAGE plpgsql;

CREATE TRIGGER insert_notification_trigger_band_application AFTER INSERT ON band_application
    FOR EACH ROW EXECUTE PROCEDURE insert_notification_trigger_band_application();

```

| Trigger Reference | Trigger Description | SQL Code |
| ----------------- | ------------------- | -------- |
| TRIGGER06         | When a member of the band reply to a band application, the database triggers a new row in the notification_trigger table so the notification trigger can further generate the the needed user_notifications                    | see below    |

```sql

CREATE OR REPLACE FUNCTION insert_notification_trigger_band_application_accepted() RETURNS trigger AS $$
    BEGIN
       
        IF NEW.status = 'accepted' THEN
            INSERT INTO notification_trigger(type,originBandApplication) VALUES('band_application_accepted',New.id);
        END IF;

        RETURN NEW;

    END;
    
$$ LANGUAGE plpgsql;

CREATE TRIGGER insert_notification_trigger_band_application_accepted AFTER UPDATE ON band_application
    FOR EACH ROW EXECUTE PROCEDURE insert_notification_trigger_band_application_accepted();

CREATE OR REPLACE FUNCTION insert_notification_trigger_band_application_rejected() RETURNS trigger AS $$
    BEGIN
       
        IF NEW.status = 'rejected' THEN
            INSERT INTO notification_trigger(type,originBandApplication) VALUES('band_application_rejected',New.id);
        END IF;

        RETURN NEW;

    END;
    
$$ LANGUAGE plpgsql;

CREATE TRIGGER insert_notification_trigger_band_application_rejected AFTER UPDATE ON band_application
    FOR EACH ROW EXECUTE PROCEDURE insert_notification_trigger_band_application_rejected();


```

| Trigger Reference | Trigger Description | SQL Code |
| ----------------- | ------------------- | -------- |
| TRIGGER07         | When a band invites a user, the database triggers a new row in the notification_trigger table so the notification trigger can further generate the the needed user_notifications                    | see below    |

```sql

CREATE OR REPLACE FUNCTION insert_notification_trigger_band_invitation() RETURNS trigger AS $$
    BEGIN
       
        INSERT INTO notification_trigger(type,originBandInvitation) VALUES('band_invitation',New.id);
        RETURN NEW;

    END;
    
$$ LANGUAGE plpgsql;

CREATE TRIGGER insert_notification_trigger_band_invitation AFTER INSERT ON band_invitation
    FOR EACH ROW EXECUTE PROCEDURE insert_notification_trigger_band_invitation();


```

| Trigger Reference | Trigger Description | SQL Code |
| ----------------- | ------------------- | -------- |
| TRIGGER08         | When a user replies to a band invitation, the database triggers a new row in the notification_trigger table so the notification trigger can further generate the the needed user_notifications                    | see below    |

```sql

CREATE OR REPLACE FUNCTION insert_notification_trigger_band_invitation_accepted() RETURNS trigger AS $$
    BEGIN
       
        IF NEW.status = 'accepted' THEN
            INSERT INTO notification_trigger(type,originBandInvitation) VALUES('band_invitation_accepted',New.id);
        END IF;

        RETURN NEW;

    END;
    
$$ LANGUAGE plpgsql;

CREATE TRIGGER insert_notification_trigger_band_invitation_accepted AFTER UPDATE ON band_invitation
    FOR EACH ROW EXECUTE PROCEDURE insert_notification_trigger_band_invitation_accepted();

CREATE OR REPLACE FUNCTION insert_notification_trigger_band_invitation_rejected() RETURNS trigger AS $$
    BEGIN
       
        IF NEW.status = 'rejected' THEN
            INSERT INTO notification_trigger(type,originBandInvitation) VALUES('band_invitation_rejected',New.id);
        END IF;

        RETURN NEW;

    END;
    
$$ LANGUAGE plpgsql;

CREATE TRIGGER insert_notification_trigger_band_invitation_rejected AFTER UPDATE ON band_invitation
    FOR EACH ROW EXECUTE PROCEDURE insert_notification_trigger_band_invitation_rejected();


```

| Trigger Reference | Trigger Description | SQL Code |
| ----------------- | ------------------- | -------- |
| TRIGGER09         | When an admin warns a user, the database triggers a new row in the notification_trigger table so the notification trigger can further generate the the needed user_notifications                    | see below    |

```sql

CREATE OR REPLACE FUNCTION insert_notification_trigger_user_warning() RETURNS trigger AS $$
    BEGIN
       
        INSERT INTO notification_trigger(type,originUserWarning) VALUES('user_warning',New.id);
        RETURN NEW;

    END;
    
$$ LANGUAGE plpgsql;

CREATE TRIGGER insert_notification_trigger_user_warning AFTER INSERT ON user_warning
    FOR EACH ROW EXECUTE PROCEDURE insert_notification_trigger_user_warning();


```

| Trigger Reference | Trigger Description | SQL Code |
| ----------------- | ------------------- | -------- |
| TRIGGER10         | When an admin warns a band, the database triggers a new row in the notification_trigger table so the notification trigger can further generate the the needed user_notifications                    | see below    |


```sql

CREATE OR REPLACE FUNCTION insert_notification_trigger_band_warning() RETURNS trigger AS $$
    BEGIN
       
        INSERT INTO notification_trigger(type,originBandWarning) VALUES('band_warning',New.id);
        RETURN NEW;

    END;
    
$$ LANGUAGE plpgsql;

CREATE TRIGGER insert_notification_trigger_band_warning AFTER INSERT ON band_warning
    FOR EACH ROW EXECUTE PROCEDURE insert_notification_trigger_band_warning();

```

## 4. Código SQL
```sql

```

## Revision history

***

GROUP1712, 4/04/2018

> João Pinheiro, up201104913@fe.up.pt

> Leonardo Teixeira, up201502848@fe.up.pt

> Danny Soares, up201505509@fe.up.pt

> João Azevedo, up201503256@fe.up.pt    |





## Revision history

***

GROUP1712, 4/04/2018

> João Pinheiro, up201104913@fe.up.pt

> Leonardo Teixeira, up201502848@fe.up.pt

> Danny Soares, up201505509@fe.up.pt

> João Azevedo, up201503256@fe.up.pt