# A9: Main accesses to the database and transactions
 
## 1. Main Accesses
 
> Main accesses to the database.

### 1.1 M01 Register User
 
| SQL Reference | Access Description |
| ------------- | ------------------ |
| Web Resource  | R104               |

```sql 

INSERT INTO mb_user(username,password,name) VALUES($username,$password,$name);

```

### 1.2 M02 Feed Posts

### 1.3 M03 Profile Posts

| SQL Reference | Access Description |
| ------------- | ------------------ |
| Web Resource  | Not yet implemented|

```sql
select * from post
join content
on post.contentId = content.id
join mb_user
on mb_user.id = $userId and mb_user.id = content.creatorId
left join comment
on comment.postId = post.id
join content a
on a.id = comment.contentId
join mb_user b
on b.id = a.creatorId;
```


### 1.4 M04 Band Profile Posts

| SQL Reference | Access Description |
| ------------- | ------------------ |
| Web Resource  | R402               |

```sql
select * from post
join content
on post.contentId = content.id
join band
on band.id = post.bandId and band.id = $bandId
left join comment
on comment.postId = post.id
join contente a
on a.id = comment.contentId
join mb_user b
on b.id = a.creatorId;
```

### 1.8 M08 New Post

### 1.9 M09 New Comment

### 1.5 M05 Friend Chat

### 1.6 M06 Band Chat

### 1.11 M11 Send Message

### 1.7 M07 Search

### 1.10 M10 New Band

### 1.11 M11 Users List

| SQL Reference | Access Description |
| ------------- | ------------------ |
| Web Resource  | R201               |

```sql 

SELECT * 
FROM mb_user
ORDER BY admin desc,name
LIMIT 10
OFFSET $offset

```

### 1.12 M12 Reported Users

| SQL Reference | Access Description |
| ------------- | ------------------ |
| Web Resource  | R203               |

```sql 

SELECT reports.user_id as user_id, reports.name as name, reports.sum as number_of_reports, warnings.total as number_of_warnings 

FROM 

    (SELECT user_id, name,sum(total) FROM 
        
        (-- user_reports 
        SELECT mb_user.id as user_id, mb_user.name as name, count(*) as total --times_reported_directly
            FROM report
            JOIN mb_user ON mb_user.id = report.reportedUserId
            WHERE report.reportType <> 'band_report'
            GROUP BY mb_user.id 

        -- user_reported_content
        UNION ALL
            SELECT mb_user.id as user_id, mb_user.name as name, count(*) as total --times_published_content_was_reported
            FROM report
            JOIN content ON content.id = report.reportedContentId
            JOIN mb_user ON content.creatorId = mb_user.id
            GROUP BY mb_user.id) as total_reported

    GROUP BY total_reported.user_id, total_reported.name) as reports

LEFT JOIN 
    (SELECT mb_user.id as user_id, mb_user.name as name, count(*) as total --times_warned
    FROM warning
    JOIN mb_user ON mb_user.id = warning.userId
    GROUP BY mb_user.id) AS warnings on warnings.user_id = reports.user_id

ORDER BY number_of_reports DESC, number_of_warnings DESC;

```

### 1.13 M13 Reported Bands

| SQL Reference | Access Description |
| ------------- | ------------------ |
| Web Resource  | R206               |

```sql 

SELECT reports.band_id as band_id, reports.name as band_name, reports.sum as number_of_reports, warnings.total as number_of_warnings 
FROM

    (SELECT band_id, name,sum(total) FROM

        (-- band_reports
        SELECT band.id as band_id, band.name as name, count(*) as total --times_reported_directly
        FROM report
        JOIN band ON band.id = report.reportedBandId
        GROUP BY band.id 

        UNION ALL

        -- band_reported_content
        SELECT band.id as band_id, band.name as name, count(*) as total --times_published_content_was_reported
        FROM report
        JOIN content ON content.id = report.reportedContentId
        LEFT JOIN post ON post.contentId = content.id --AND post.bandId IS NOT NULL
        JOIN band ON post.bandId = band.id
        GROUP BY band.id) as total_reported

    GROUP BY total_reported.band_id, total_reported.name) as reports

LEFT JOIN 
    (SELECT band.id as band_id, band.name as name, count(*) as total --times_warned
     FROM warning
     JOIN band ON band.id = warning.bandId
     GROUP BY band.id) AS warnings on warnings.band_id = reports.band_id


ORDER BY number_of_reports DESC, number_of_warnings DESC;

```

### 1.14 M14 User Reports


| SQL Reference | Access Description  |
| ------------- | ------------------- |
| Web Resource  | Not yet implemented |

```sql 

SELECT *
FROM 
    (SELECT mb_user.id as user_id, mb_user.name as reportedUser, report.text as text, users2.name as reporterUser, 'na' as contentText, 0 as postId, 0 as messageId, 0 as commentId
    FROM report
    JOIN mb_user ON report.reportedUserId = mb_user.id
    JOIN mb_user as users2 ON users2.id = report.reporterUserId

    UNION ALL

    SELECT mb_user.id as user_id,mb_user.name as reportedUser, report.text as text, users2.name as reporterUser, content.text as contentText, post.id as postId, message.id as messageId, comment.id as commentId
    FROM report
    JOIN content ON content.id = report.reportedContentId
    LEFT JOIN post ON post.contentId = content.id
    LEFT JOIN message ON message.contentId = content.id
    LEFT JOIN comment ON comment.contentId = content.id
    JOIN mb_user ON content.creatorId = mb_user.id
    JOIN mb_user as users2 ON users2.id = report.reporterUserId) as reports


WHERE reports.id = $user_id
ORDER BY contentText;


```

### 1.15 M15 Band Reports

| SQL Reference | Access Description  |
| ------------- | ------------------- |
| Web Resource  | Not yet implemented |

```sql 

SELECT *
FROM 
    (SELECT band.id as band_id, band.name as reportedBand, report.text as complaint, users2.name as reporterUser, 'na' as contentText, 0 as postId
    FROM report
    JOIN band ON report.reportedBandId = band.id
    JOIN mb_user as users2 ON users2.id = report.reporterUserId

    UNION ALL

    SELECT band.id as band_id,band.name as reportedBand, report.text as complaint, users2.name as reporterUser, content.text as contentText, post.id as postId
    FROM report
    JOIN content ON content.id = report.reportedContentId
    LEFT JOIN post ON post.contentId = content.id
    LEFT JOIN message ON message.contentId = content.id
    JOIN band ON post.bandId = band.id
    JOIN mb_user as users2 ON users2.id = report.reporterUserId) as reports


WHERE reports.band_id = $band_id
ORDER BY contentText;


```


 

 
## 2. Transactions
 
> Transactions needed to assure the integrity of the data.
 
| T01             | New Post                            |
| --------------- | ----------------------------------- |
| Isolation level | REPEATABLE READ |
| Justification   | In a new post, it's needed to add the data of the new post into *post* and *content* tables, in a single transaction in order to keep the consistency. The isolation level is Repeatable Read, because, otherwise, an update of content_id_seq could happen, due to an insert in the table work committed by a concurrent transaction, and as a result, inconsistent data would be stored.   |


```sql
BEGIN TRANSACTION;
SET TRANSACTION ISOLATION LEVEL REPEATABLE READ 
 
-- Insert content
 INSERT INTO content (text, creatorId) 
  VALUES ($text, $creatorId); 
 
-- Insert post 
 INSERT INTO post (private, contentId, bandId) 
  VALUES ($private, currval('content_id_seq'), $bandId); 
 
COMMIT;
```         

| T02             | New Message                            |
| --------------- | ----------------------------------- |
| Isolation level | REPEATABLE READ |
| Justification   | In a new message, it's needed to add the data of the new message into *message* and *content* tables, in a single transaction in order to keep the consistency. The isolation level is Repeatable Read, because, otherwise, an update of content_id_seq could happen, due to an insert in the table work committed by a concurrent transaction, and as a result, inconsistent data would be stored.   |


```sql
BEGIN TRANSACTION;
SET TRANSACTION ISOLATION LEVEL REPEATABLE READ 
 
-- Insert content
 INSERT INTO content (text, creatorId) 
  VALUES ($text, $creatorId); 
 
-- Insert message 
 INSERT INTO message (contentId, receiverId, bandId) 
  VALUES (currval('content_id_seq'), $receiverId, $bandId); 
 
COMMIT;
``` 

| T03             | New Comment                            |
| --------------- | ----------------------------------- |
| Isolation level | REPEATABLE READ |
| Justification   | In a new comment, it's needed to add the data of the new comment into *comment* and *content* tables, in a single transaction in order to keep the consistency. The isolation level is Repeatable Read, because, otherwise, an update of content_id_seq could happen, due to an insert in the table work committed by a concurrent transaction, and as a result, inconsistent data would be stored.   |


```sql
BEGIN TRANSACTION;
SET TRANSACTION ISOLATION LEVEL REPEATABLE READ 
 
-- Insert content
 INSERT INTO content (text, creatorId) 
  VALUES ($text, $creatorId); 
 
-- Insert comment 
 INSERT INTO comment (contentId, postId) 
  VALUES (currval('content_id_seq'), $postId); 
 
COMMIT;
``` 

| T04             | Get last 5 messages and unread messages count |
| --------------- | ----------------------------------- |
| Isolation level | SERIALIZABLE READ ONLY |
| Justification   | In the middle of the transaction, the insertion of new rows in the user_notification table can occur, which implies that the information retrieved in both selects is different, consequently resulting in a Phantom Read. It's READ ONLY because it only uses Selects.   |


```sql
BEGIN TRANSACTION;
SET TRANSACTION ISOLATION LEVEL SERIALIZABLE READ ONLY
 
-- Get number of unread message notifications

SELECT count(*)
FROM user_notification
JOIN notification_trigger ON user_notification.notificationTriggerId = notification_trigger.id AND notification_trigger.type = 'message'
WHERE visualizedDate IS NOT NULL
AND userId = $userId;

-- Get the 5 most recent message notifications received 

WITH messageNotifs AS (
    SELECT user_notification.notificationTriggerId, user_notification.text, content.creatorId, notification_trigger.date, user_notification.visualizedDate
    FROM user_notification
    JOIN notification_trigger ON user_notification.notificationTriggerId = notification_trigger.id AND notification_trigger.type = 'message'
    JOIN message ON message.id = notification_trigger.originMessage
    JOIN content ON content.id = message.contentId
    WHERE user_notification.userId = $userId
  )
SELECT *  
FROM messageNotifs
WHERE (messageNotifs.date, messageNotifs.creatorId) IN (
  SELECT MAX(messageNotifs.date), messageNotifs.creatorId
  FROM messageNotifs
  GROUP BY messageNotifs.creatorId
)  
ORDER BY messageNotifs.date DESC
LIMIT 5;

 
COMMIT;
``` 

| T05             | Get last 8 notifications and unread notifications count |
| --------------- | ----------------------------------- |
| Isolation level | SERIALIZABLE READ ONLY |
| Justification   | In the middle of the transaction, the insertion of new rows in the user_notification table can occur, which implies that the information retrieved in both selects is different, consequently resulting in a Phantom Read. It's READ ONLY because it only uses Selects.   |


```sql
BEGIN TRANSACTION;
SET TRANSACTION ISOLATION LEVEL SERIALIZABLE READ ONLY
 
-- Get number of unread notifications

SELECT count(*)
FROM user_notification
JOIN notification_trigger ON user_notification.notificationTriggerId = notification_trigger.id AND notification_trigger.type != 'message'
WHERE visualizedDate IS NOT NULL
AND userId = $userId;

-- Get the 8 most recent notifications received 

SELECT notification_trigger.id, user_notification.text, notification_trigger.date, notification_trigger.type
FROM user_notification
JOIN notification_trigger ON user_notification.notificationTriggerId = notification_trigger.id AND notification_trigger.type != 'message'
WHERE user_notification.userId = $userId
ORDER BY notification_trigger.date DESC
LIMIT 8;
 
COMMIT;
``` 
## Revision history
 
Changes made to the first submission:
1. Item 1
1. Item 2
 
***
 
GROUP17xx, xx/xx/2018
 
> Group member 1 name, email
> Group member 2 name, email