# A9: Main accesses to the database and transactions
 
## 1. Main Accesses
 
> Main accesses to the database.
 
| SQL Reference | Access Description                    |
| ------------- | ------------------------------------- |
| Web Resource  | R104                                  |

```sql 

INSERT INTO mb_user(username,password,name) VALUES($username,$password,$name);

```
 

 
## 2. Transactions
 
> Transactions needed to assure the integrity of the data.
 
| T01             | New Post                            |
| --------------- | ----------------------------------- |
| Isolation level | REPEATABLE READ |
| Justification   | In a new post, it's needed to add the data of the new post into *post* and *content* tables, in a single transaction in order to keep the consistency. The isolation level is Repeatable Read, because, otherwise, an update of content_id_seq could happen, due to an insert in the table work committed by a concurrent transaction, and as a result, inconsistent data would be stored.   |


```sql
BEGIN TRANSACTION;
SET TRANSACTION ISOLATION LEVEL REPEATABLE READ 
 
-- Insert content
 INSERT INTO content (text, creatorId) 
  VALUES ($text, $creatorId); 
 
-- Insert post 
 INSERT INTO post (private, contentId, bandId) 
  VALUES ($private, currval('content_id_seq'), $bandId); 
 
COMMIT;
```         

| T02             | New Message                            |
| --------------- | ----------------------------------- |
| Isolation level | REPEATABLE READ |
| Justification   | In a new message, it's needed to add the data of the new message into *message* and *content* tables, in a single transaction in order to keep the consistency. The isolation level is Repeatable Read, because, otherwise, an update of content_id_seq could happen, due to an insert in the table work committed by a concurrent transaction, and as a result, inconsistent data would be stored.   |


```sql
BEGIN TRANSACTION;
SET TRANSACTION ISOLATION LEVEL REPEATABLE READ 
 
-- Insert content
 INSERT INTO content (text, creatorId) 
  VALUES ($text, $creatorId); 
 
-- Insert message 
 INSERT INTO message (contentId, receiverId, bandId) 
  VALUES (currval('content_id_seq'), $receiverId, $bandId); 
 
COMMIT;
``` 

| T03             | New Comment                            |
| --------------- | ----------------------------------- |
| Isolation level | REPEATABLE READ |
| Justification   | In a new comment, it's needed to add the data of the new comment into *comment* and *content* tables, in a single transaction in order to keep the consistency. The isolation level is Repeatable Read, because, otherwise, an update of content_id_seq could happen, due to an insert in the table work committed by a concurrent transaction, and as a result, inconsistent data would be stored.   |


```sql
BEGIN TRANSACTION;
SET TRANSACTION ISOLATION LEVEL REPEATABLE READ 
 
-- Insert content
 INSERT INTO content (text, creatorId) 
  VALUES ($text, $creatorId); 
 
-- Insert comment 
 INSERT INTO comment (contentId, postId) 
  VALUES (currval('content_id_seq'), $postId); 
 
COMMIT;
``` 

| T04             | Get last 5 messages and unread messages count |
| --------------- | ----------------------------------- |
| Isolation level | SERIALIZABLE READ ONLY |
| Justification   | In the middle of the transaction, the insertion of new rows in the user_notification table can occur, which implies that the information retrieved in both selects is different, consequently resulting in a Phantom Read. It's READ ONLY because it only uses Selects.   |


```sql
BEGIN TRANSACTION;
SET TRANSACTION ISOLATION LEVEL SERIALIZABLE READ ONLY
 
-- Get number of unread message notifications

SELECT count(*)
FROM user_notification
JOIN notification_trigger ON user_notification.notificationTriggerId = notification_trigger.id AND notification_trigger.type = 'message'
WHERE visualizedDate IS NOT NULL
AND userId = $userId;

-- Get the 5 most recent message notifications received 

WITH messageNotifs AS (
    SELECT user_notification.notificationTriggerId, user_notification.text, content.creatorId, notification_trigger.date, user_notification.visualizedDate
    FROM user_notification
    JOIN notification_trigger ON user_notification.notificationTriggerId = notification_trigger.id AND notification_trigger.type = 'message'
    JOIN message ON message.id = notification_trigger.originMessage
    JOIN content ON content.id = message.contentId
    WHERE user_notification.userId = $userId
  )
SELECT *  
FROM messageNotifs
WHERE (messageNotifs.date, messageNotifs.creatorId) IN (
  SELECT MAX(messageNotifs.date), messageNotifs.creatorId
  FROM messageNotifs
  GROUP BY messageNotifs.creatorId
)  
ORDER BY messageNotifs.date DESC
LIMIT 5;

 
COMMIT;
``` 

| T05             | Get last 8 notifications and unread notifications count |
| --------------- | ----------------------------------- |
| Isolation level | SERIALIZABLE READ ONLY |
| Justification   | In the middle of the transaction, the insertion of new rows in the user_notification table can occur, which implies that the information retrieved in both selects is different, consequently resulting in a Phantom Read. It's READ ONLY because it only uses Selects.   |


```sql
BEGIN TRANSACTION;
SET TRANSACTION ISOLATION LEVEL SERIALIZABLE READ ONLY
 
-- Get number of unread notifications

SELECT count(*)
FROM user_notification
JOIN notification_trigger ON user_notification.notificationTriggerId = notification_trigger.id AND notification_trigger.type != 'message'
WHERE visualizedDate IS NOT NULL
AND userId = $userId;

-- Get the 8 most recent notifications received 

SELECT notification_trigger.id, user_notification.text, notification_trigger.date, notification_trigger.type
FROM user_notification
JOIN notification_trigger ON user_notification.notificationTriggerId = notification_trigger.id AND notification_trigger.type != 'message'
WHERE user_notification.userId = $userId
ORDER BY notification_trigger.date DESC
LIMIT 8;
 
COMMIT;
``` 
## Revision history
 
Changes made to the first submission:
1. Item 1
1. Item 2
 
***
 
GROUP17xx, xx/xx/2018
 
> Group member 1 name, email
> Group member 2 name, email