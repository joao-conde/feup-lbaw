# A9: Main accesses to the database and transactions
 
## 1. Main Accesses
 
> Main accesses to the database.

### 1.1 M01 Register User
 
| SQL Reference | Access Description |
| ------------- | ------------------ |
| Web Resource  | R104               |

```sql 

INSERT INTO mb_user(username,password,name) VALUES($username,$password,$name);

```

### 1.2 M02 Feed Posts

### 1.3 M03 Profile Posts

### 1.4 M04 Band Profile Posts

### 1.8 M08 New Post

### 1.9 M09 New Comment

### 1.5 M05 Friend Chat

### 1.6 M06 Band Chat

### 1.11 M11 Send Message

### 1.7 M07 Search

### 1.10 M10 New Band

### 1.11 M11 Users List

| SQL Reference | Access Description |
| ------------- | ------------------ |
| Web Resource  | R201               |

```sql 

SELECT * 
FROM mb_user
ORDER BY admin desc,name
LIMIT 10
OFFSET $offset

```

### 1.12 M12 Reported Users

| SQL Reference | Access Description |
| ------------- | ------------------ |
| Web Resource  | R203               |

```sql 

SELECT reports.user_id as user_id, reports.name as name, reports.sum as number_of_reports, warnings.total as number_of_warnings 

FROM 

    (SELECT user_id, name,sum(total) FROM 
        
        (-- user_reports 
        SELECT mb_user.id as user_id, mb_user.name as name, count(*) as total --times_reported_directly
            FROM report
            JOIN mb_user ON mb_user.id = report.reportedUserId
            WHERE report.reportType <> 'band_report'
            GROUP BY mb_user.id 

        -- user_reported_content
        UNION ALL
            SELECT mb_user.id as user_id, mb_user.name as name, count(*) as total --times_published_content_was_reported
            FROM report
            JOIN content ON content.id = report.reportedContentId
            JOIN mb_user ON content.contentCreatorId = mb_user.id
            GROUP BY mb_user.id) as total_reported

    GROUP BY total_reported.user_id, total_reported.name) as reports

LEFT JOIN 
    (SELECT mb_user.id as user_id, mb_user.name as name, count(*) as total --times_warned
    FROM warning
    JOIN mb_user ON mb_user.id = warning.userId
    GROUP BY mb_user.id) AS warnings on warnings.user_id = reports.user_id

ORDER BY number_of_reports DESC, number_of_warnings DESC;

```

### 1.13 M13 Reported Bands

| SQL Reference | Access Description |
| ------------- | ------------------ |
| Web Resource  | R206               |

```sql 

SELECT reports.band_id as band_id, reports.name as band_name, reports.sum as number_of_reports, warnings.total as number_of_warnings 
FROM

    (SELECT band_id, name,sum(total) FROM

        (-- band_reports
        SELECT band.id as band_id, band.name as name, count(*) as total --times_reported_directly
        FROM report
        JOIN band ON band.id = report.reportedBandId
        GROUP BY band.id 

        UNION ALL

        -- band_reported_content
        SELECT band.id as band_id, band.name as name, count(*) as total --times_published_content_was_reported
        FROM report
        JOIN content ON content.id = report.reportedContentId
        LEFT JOIN post ON post.contentId = content.id --AND post.bandId IS NOT NULL
        JOIN band ON post.bandId = band.id
        GROUP BY band.id) as total_reported

    GROUP BY total_reported.band_id, total_reported.name) as reports

LEFT JOIN 
    (SELECT band.id as band_id, band.name as name, count(*) as total --times_warned
     FROM warning
     JOIN band ON band.id = warning.bandId
     GROUP BY band.id) AS warnings on warnings.band_id = reports.band_id


ORDER BY number_of_reports DESC, number_of_warnings DESC;

```

### 1.14 M14 User Reports


| SQL Reference | Access Description  |
| ------------- | ------------------- |
| Web Resource  | Not yet implemented |

```sql 

SELECT *
FROM 
    (SELECT mb_user.id as user_id, mb_user.name as reportedUser, report.text as text, users2.name as reporterUser, 'na' as contentText, 0 as postId, 0 as messageId, 0 as commentId
    FROM report
    JOIN mb_user ON report.reportedUserId = mb_user.id
    JOIN mb_user as users2 ON users2.id = report.reporterUserId

    UNION ALL

    SELECT mb_user.id as user_id,mb_user.name as reportedUser, report.text as text, users2.name as reporterUser, content.text as contentText, post.id as postId, message.id as messageId, comment.id as commentId
    FROM report
    JOIN content ON content.id = report.reportedContentId
    LEFT JOIN post ON post.contentId = content.id
    LEFT JOIN message ON message.contentId = content.id
    LEFT JOIN comment ON comment.contentId = content.id
    JOIN mb_user ON content.contentCreatorId = mb_user.id
    JOIN mb_user as users2 ON users2.id = report.reporterUserId) as reports


WHERE reports.id = $user_id
ORDER BY contentText;


```

### 1.15 M15 Band Reports

| SQL Reference | Access Description  |
| ------------- | ------------------- |
| Web Resource  | Not yet implemented |

```sql 

SELECT *
FROM 
    (SELECT band.id as band_id, band.name as reportedBand, report.text as complaint, users2.name as reporterUser, 'na' as contentText, 0 as postId
    FROM report
    JOIN band ON report.reportedBandId = band.id
    JOIN mb_user as users2 ON users2.id = report.reporterUserId

    UNION ALL

    SELECT band.id as band_id,band.name as reportedBand, report.text as complaint, users2.name as reporterUser, content.text as contentText, post.id as postId
    FROM report
    JOIN content ON content.id = report.reportedContentId
    LEFT JOIN post ON post.contentId = content.id
    LEFT JOIN message ON message.contentId = content.id
    JOIN band ON post.bandId = band.id
    JOIN mb_user as users2 ON users2.id = report.reporterUserId) as reports


WHERE reports.band_id = $band_id
ORDER BY contentText;


```


 

 
## 2. Transactions
 
> Transactions needed to assure the integrity of the data.
 
| T01                 | New Post                                                                                                                                                |
| ------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Justification       | In a new post request, its needed to add the data of the post in *post* and *content* tables, in a single transaction in order to keep the consistency. |
| Isolation level     | Isolation level of the transaction.                                                                                                                     |
| `Complete SQL Code` |
 
...
 
## Revision history
 
Changes made to the first submission:
1. Item 1
1. Item 2
 
***
 
GROUP17xx, xx/xx/2018
 
> Group member 1 name, email
> Group member 2 name, email